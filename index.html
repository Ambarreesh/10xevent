<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>API MAZE • Event Console – 10X Club KARE</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --glass: rgba(255,255,255,0.07);
    --glass-strong: rgba(255,255,255,0.14);
    --border: rgba(255,255,255,0.18);
    --text: #fff;
    --accent: #1657ff;
    --accent2:#F2551D;
    --success:#0f9d58;
    --danger:#e53935;
    --radius: 18px;
    --shadow: 0 24px 40px rgba(0,0,0,.3);
  }
  *{ box-sizing:border-box; }
  body{
    margin:0; font-family:'Montserrat',sans-serif; background:#000; color:var(--text);
    background-image:
      radial-gradient(circle at 10% 20%, rgba(22,87,255,0.06) 0 55%, transparent 55%),
      radial-gradient(circle at 90% 80%, rgba(242,85,29,0.06) 0 55%, transparent 55%);
    background-attachment: fixed;
    min-height:100vh;
  }
  a{ color: var(--accent); }

  .container{
    max-width:1200px; margin:0 auto; padding:20px 16px 80px;
  }
  .glass{
    background:var(--glass);
    backdrop-filter: blur(14px) saturate(180%);
    -webkit-backdrop-filter: blur(14px) saturate(180%);
    border:1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  header.hero{
    display:flex; gap:18px; align-items:center; justify-content:space-between;
    padding:22px 20px; margin:18px 0 24px; position:relative; overflow:hidden; flex-wrap:wrap;
  }
  header.hero::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.03) 50%, transparent 100%);
    transform:skewX(-20deg) translateX(-100%); animation:shine 5s infinite;
  }
  @keyframes shine{
    0%{ transform:skewX(-20deg) translateX(-120%); }
    100%{ transform:skewX(-20deg) translateX(120%); }
  }
  .logos{ display:flex; align-items:center; gap:10px; }
  .logos img{
    height:56px; object-fit:contain; background:rgba(255,255,255,0.05);
    border-radius:12px; padding:6px 10px;
  }
  h1,h2,h3{ margin:0 0 12px; }
  .tag{
    display:inline-block; padding:4px 10px; border-radius:999px;
    background:rgba(255,255,255,0.08); font-size:.85rem;
  }
  .grid{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:18px;
  }
  section.block{ padding:20px 18px; }
  .btn{
    appearance:none; border:none; border-radius:999px; padding:12px 18px; font-weight:700; cursor:pointer;
    display:inline-flex; align-items:center; justify-content:center; gap:8px; transition:.2s;
  }
  .btn-primary{ background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#fff; }
  .btn-outline{ background:transparent; border:1px solid rgba(255,255,255,.2); color:#fff; }
  .btn-danger{ background: var(--danger); color:#fff; }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; }
  input, select, textarea{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,0.06); color:#fff; outline:none; font-family:inherit;
  }
  label{ display:block; margin-bottom:6px; font-size:.9rem; opacity:.85; }
  .muted{ opacity:.7; font-size:.85rem; }
  .flex{ display:flex; gap:10px; flex-wrap:wrap; }
  .hidden{ display:none !important; }
  .tabbar{
    display:flex; gap:8px; margin:22px 0 14px; flex-wrap:wrap;
  }
  .tab{
    padding:8px 14px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid transparent; cursor:pointer;
    font-weight:600; font-size:.9rem;
  }
  .tab.active{ border-color:rgba(255,255,255,.25); background:rgba(255,255,255,.12); }
  table{
    width:100%; border-collapse:collapse; font-size:.92rem;
  }
  th,td{
    border-bottom:1px solid rgba(255,255,255,.08); padding:8px 6px; vertical-align:top;
  }
  th{text-align:left; position:sticky; top:0; background:rgba(0,0,0,.35); backdrop-filter:blur(6px); z-index:1;}
  .score-input{
    width:64px; text-align:center; border-radius:8px; padding:6px 4px; background:rgba(255,255,255,0.04);
  }
  .pill{
    display:inline-block; padding:2px 8px; font-size:.75rem; border-radius:999px; margin-left:4px;
  }
  .pill.judge{ background:rgba(22,87,255,.2); }
  .pill.participant{ background:rgba(242,85,29,.2); }
  .pill.locked{ background:rgba(15,157,88,.2); }
  .countdown{
    display:flex; gap:10px; align-items:center; font-weight:600; letter-spacing:.4px;
  }
  .countdown span{
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
    padding:6px 10px; border-radius:8px; min-width:56px; text-align:center;
  }
  .inline-code{
    background:rgba(255,255,255,.06); padding:2px 6px; border-radius:6px; font-family:monospace;
  }
  .toast{
    position:fixed; bottom:18px; right:18px; background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.15); color:#fff; padding:10px 14px; border-radius:10px; display:none;
  }
  .sticky-top{ position:sticky; top:0; z-index:50; }
</style>
</head>
<body>
<div class="container">

  <!-- HERO -->
  <header class="hero glass">
    <div class="logos">
      <img src="img/image 26.png" alt="10X Club">
      <img src="img/klu.png" alt="KARE">
    </div>

    <div style="flex:1 1 auto;">
      <h1>API MAZE – Event Console</h1>
      <div class="tag">Aug 2, 2025 • Starts 9:30 AM • 8 Hours</div>
      <div class="countdown" id="countdown"></div>
    </div>

    <!-- Auth -->
    <div id="authBox" style="display:flex; align-items:center; gap:8px;">
      <button class="btn btn-outline" id="openSignin">Sign in</button>

      <!-- NEW: visible logout button -->
      <button class="btn btn-outline hidden" id="logoutTopBtn">Logout</button>

      <div id="profileBox" class="hidden" style="position:relative;">
        <button class="btn btn-outline" id="avatarBtn" style="width:38px;height:38px;border-radius:50%;padding:0;font-weight:700;">U</button>
        <div id="profileMenu" class="glass hidden" style="position:absolute; right:0; top:48px; min-width:220px; padding:10px;">
          <div style="padding:6px 8px; font-size:.85rem; opacity:.8;" id="profileEmail">user@klu.ac.in</div>
          <hr style="border:none;border-top:1px solid rgba(255,255,255,.1); margin:6px 0;">
          <button class="btn btn-outline" id="viewProfileBtn" style="width:100%; margin:4px 0;">Profile</button>
          <button class="btn btn-outline" id="logoutBtn" style="width:100%; margin:4px 0;">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabbar sticky-top glass" style="padding:8px;">
    <button class="tab active" data-tab="overviewTab">Overview</button>
    <button class="tab" data-tab="teamTab">Team</button>
    <button class="tab" data-tab="roundsTab">Rounds & Submissions</button>
    <button class="tab" data-tab="leaderboardTab">Leaderboard</button>
    <button class="tab" data-tab="judgeTab">Judge Console <span class="pill judge">staff</span></button>
  </div>

  <!-- Overview -->
  <section id="overviewTab" class="block glass">
    <h2>Event Overview</h2>
    <p>
      <strong>API Maze</strong> is a Build‑an‑App challenge. Use any public API (OpenWeather, Google Books, Jokes API, etc.) to craft
      something useful/fun in <strong>8 hours</strong>. You can participate in <strong>teams of 2–4 members</strong> (you all registered individually; now you’ll form your team here).
    </p>

    <h3>Prizes & Credits</h3>
    <ul>
      <li>1st Prize – ₹3000</li>
      <li>2nd Prize – ₹1500</li>
      <li>3rd Prize – ₹1000</li>
      <li>1 EE Credit for qualified participants</li>
      <li>Certificate for everyone</li>
    </ul>

    <h3>Rounds (Total 100 Marks)</h3>
    <ol>
      <li>
        <strong>Round 1 – Problem Identification & Planning (1 hour) — 15 marks</strong><br/>
        Problem relevance & clarity (5), Feasibility & creativity (5), Relevance of chosen API (5)
      </li>
      <li>
        <strong>Round 2 – App/Page Development (5 hours) — 55 marks</strong><br/>
        Correct & useful API integration (20), Functionality (20), UI/UX (10), Code quality (5)
      </li>
      <li>
        <strong>Round 3 – Final Presentation & Demo (2 hours) — 30 marks</strong><br/>
        Explanation & demo (10), Creativity & impact (10), Time management (5), Team collaboration / Solo effort (5)
      </li>
    </ol>
  </section>

  <!-- Team -->
  <section id="teamTab" class="block glass hidden">
    <h2>Your Team</h2>
    <div id="teamNotSigned" class="muted">Sign in to create/join a team.</div>

    <div id="teamSection" class="hidden">
      <div id="teamInfo" class="hidden"></div>

      <div id="teamActions">
        <button class="btn btn-primary" id="createTeamBtn">Create Team</button>
        <button class="btn btn-outline" id="joinTeamBtn">Join Team with Code</button>
      </div>

      <!-- Create team modal-ish block -->
      <div id="createTeamBox" class="hidden" style="margin-top:16px;">
        <h3>Create Team</h3>
        <div class="muted">Min 2, Max 4 members</div>
        <label>Team Name</label>
        <input id="createTeamName" placeholder="Your awesome team name" />
        <button class="btn btn-primary" id="doCreateTeam">Create</button>
        <button class="btn btn-outline" id="cancelCreateTeam">Cancel</button>
      </div>

      <!-- Join team -->
      <div id="joinTeamBox" class="hidden" style="margin-top:16px;">
        <h3>Join Team</h3>
        <label>Join Code</label>
        <input id="joinCodeInput" placeholder="e.g., X1Y2Z3" />
        <button class="btn btn-primary" id="doJoinTeam">Join</button>
        <button class="btn btn-outline" id="cancelJoinTeam">Cancel</button>
      </div>
    </div>
  </section>

  <!-- Rounds -->
  <section id="roundsTab" class="block glass hidden">
    <h2>Rounds & Submissions</h2>
    <div id="roundsNotSigned" class="muted">Sign in & join a team to submit.</div>

    <div id="roundsSection" class="hidden">
      <div id="roundsLockedNote" class="muted hidden" style="margin-bottom:10px;">
        Your team is locked. You can submit/update round details.
      </div>

      <!-- Round 1 -->
      <div class="glass" style="padding:16px;margin-bottom:14px;">
        <h3>Round 1 – Problem Identification & Planning (15)</h3>
        <form id="r1Form">
          <label>Problem (what are you solving?)</label>
          <textarea id="r1Problem" rows="3" required></textarea>

          <label>Proposed Solution (short)</label>
          <textarea id="r1Solution" rows="3" required></textarea>

          <label>Chosen Public API</label>
          <input id="r1Api" required />

          <button class="btn btn-primary" id="r1Save">Save / Update</button>
        </form>
      </div>

      <!-- Round 2 -->
      <div class="glass" style="padding:16px;margin-bottom:14px;">
        <h3>Round 2 – App/Page Development (55)</h3>
        <form id="r2Form">
          <label>GitHub/Repo URL</label>
          <input id="r2Repo" placeholder="https://github.com/..." />

          <label>Live / Demo URL</label>
          <input id="r2Demo" placeholder="https://..." />

          <label>Short Notes (optional)</label>
          <textarea id="r2Notes" rows="3"></textarea>

          <button class="btn btn-primary" id="r2Save">Save / Update</button>
        </form>
      </div>

      <!-- Round 3 -->
      <div class="glass" style="padding:16px;">
        <h3>Round 3 – Final Presentation & Demo (30)</h3>
        <form id="r3Form">
          <label>Slides / Presentation Link</label>
          <input id="r3Slides" placeholder="https://..." />

          <label>Anything else to tell the jury?</label>
          <textarea id="r3Notes" rows="3"></textarea>

          <button class="btn btn-primary" id="r3Save">Save / Update</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Leaderboard -->
  <section id="leaderboardTab" class="block glass hidden">
    <h2>Leaderboard</h2>
    <div class="muted" id="lbInfo">Scores appear as judges enter them.</div>
    <div style="overflow:auto;">
      <table id="leaderboardTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Team</th>
            <th>R1 (15)</th>
            <th>R2 (55)</th>
            <th>R3 (30)</th>
            <th>Total (100)</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Judge Console -->
  <section id="judgeTab" class="block glass hidden">
    <h2>Judge Console <span class="pill judge">staff</span></h2>
    <div id="judgeNotAllowed" class="muted">You are not authorized as a judge.</div>

    <div id="judgeSection" class="hidden">
      <div style="margin-bottom:10px;">
        <label>Round</label>
        <select id="judgeRound">
          <option value="1">Round 1 (15)</option>
          <option value="2">Round 2 (55)</option>
          <option value="3">Round 3 (30)</option>
        </select>
      </div>

      <div style="overflow:auto; max-height:65vh;">
        <table id="judgeTable">
          <thead id="judgeHead"></thead>
          <tbody id="judgeBody"></tbody>
        </table>
      </div>

      <button class="btn btn-primary" id="saveScoresBtn" style="margin-top:8px;">Save Scores</button>
    </div>
  </section>
</div>

<!-- ===== Signin Modal ===== -->
<div id="signinOverlay" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex; align-items:center; justify-content:center; z-index:9999; padding:12px;">
  <div class="glass" style="max-width:380px;width:100%;padding:18px 16px;position:relative;">
    <img src="img/image 26.png" alt="logo" style="height:56px; display:block; margin:0 auto 12px;" />
    <button style="position:absolute; top:8px; right:10px; background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer;" id="signinClose">&times;</button>
    <h3 style="text-align:center;margin-bottom:10px;">Sign in</h3>
    <div id="signinError" class="muted" style="color:#ff7b7b; display:none; margin-bottom:6px;"></div>
    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <button class="btn btn-outline" id="tabSignIn" style="flex:1;">Sign in</button>
      <button class="btn btn-outline" id="tabSignUp" style="flex:1;">Sign up</button>
    </div>

    <!-- sign in -->
    <form id="signinForm">
      <label>Email (@klu.ac.in only)</label>
      <input id="signinEmail" type="email" required placeholder="you@klu.ac.in" />
      <label>Password</label>
      <input id="signinPassword" type="password" required />
      <button class="btn btn-primary" id="signinBtn" style="width:100%; margin-top:8px;">Sign in</button>
      <button type="button" class="btn btn-outline" id="forgotBtn" style="width:100%; margin-top:6px;">Forgot password</button>
      <button type="button" class="btn btn-outline" id="googleBtn" style="width:100%; margin-top:6px;">Sign in with Google</button>
    </form>

    <!-- sign up -->
    <form id="signupForm" class="hidden">
      <label>Full Name</label>
      <input id="signupName" />
      <label>Email (@klu.ac.in only)</label>
      <input id="signupEmail" type="email" required placeholder="you@klu.ac.in" />
      <label>Password (min 6 chars)</label>
      <input id="signupPassword" type="password" required />
      <label>Confirm Password</label>
      <input id="signupPassword2" type="password" required />
      <button class="btn btn-primary" id="signupBtn" style="width:100%; margin-top:8px;">Create account</button>
      <button type="button" class="btn btn-outline" id="googleBtn2" style="width:100%; margin-top:6px;">Sign up with Google</button>
    </form>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase + App -->
<script type="module">
/* ---------------- Firebase ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword,
  GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail,
  signOut, createUserWithEmailAndPassword, updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, addDoc,
  collection, serverTimestamp, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ------------- CONFIG ------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBMgdNYVlyHlZYIgCs8d7thZHmsbGEVxi8",
  authDomain: "console10x.firebaseapp.com",
  projectId: "console10x",
  storageBucket: "console10x.firebasestorage.app",
  messagingSenderId: "550818929645",
  appId: "1:550818929645:web:4d915e80a37622122d25e4"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ---------------- Constants ---------------- */
const EVENT_ID   = "api-maze-2025";
const EVENT_NAME = "API MAZE";
const START_AT   = new Date("2025-08-02T09:30:00+05:30"); // 9:30 AM IST

/* ---------------- State ---------------- */
let user = null;
let eventConfig = { judges: [], minTeamSize: 2, maxTeamSize: 4 };
let myTeamDoc = null;
let isJudge = false;

/* ---------------- DOM ---------------- */
const tabs = document.querySelectorAll('.tab');
const tabBlocks = {
  overviewTab:    document.getElementById('overviewTab'),
  teamTab:        document.getElementById('teamTab'),
  roundsTab:      document.getElementById('roundsTab'),
  leaderboardTab: document.getElementById('leaderboardTab'),
  judgeTab:       document.getElementById('judgeTab')
};

const countdownEl       = document.getElementById('countdown');
const toastEl           = document.getElementById('toast');

const openSignin        = document.getElementById('openSignin');
const signinOverlay     = document.getElementById('signinOverlay');
const signinClose       = document.getElementById('signinClose');
const tabSignIn         = document.getElementById('tabSignIn');
const tabSignUp         = document.getElementById('tabSignUp');
const signinForm        = document.getElementById('signinForm');
const signupForm        = document.getElementById('signupForm');
const signinError       = document.getElementById('signinError');
const signinEmail       = document.getElementById('signinEmail');
const signinPassword    = document.getElementById('signinPassword');
const signupName        = document.getElementById('signupName');
const signupEmail       = document.getElementById('signupEmail');
const signupPassword    = document.getElementById('signupPassword');
const signupPassword2   = document.getElementById('signupPassword2');
const googleBtn         = document.getElementById('googleBtn');
const googleBtn2        = document.getElementById('googleBtn2');
const forgotBtn         = document.getElementById('forgotBtn');

const profileBox        = document.getElementById('profileBox');
const avatarBtn         = document.getElementById('avatarBtn');
const profileMenu       = document.getElementById('profileMenu');
const profileEmail      = document.getElementById('profileEmail');
const viewProfileBtn    = document.getElementById('viewProfileBtn');
const logoutBtn         = document.getElementById('logoutBtn');
const logoutTopBtn      = document.getElementById('logoutTopBtn'); // NEW

const teamNotSigned     = document.getElementById('teamNotSigned');
const teamSection       = document.getElementById('teamSection');
const teamInfo          = document.getElementById('teamInfo');
const teamActions       = document.getElementById('teamActions');
const createTeamBtn     = document.getElementById('createTeamBtn');
const joinTeamBtn       = document.getElementById('joinTeamBtn');
const createTeamBox     = document.getElementById('createTeamBox');
const createTeamName    = document.getElementById('createTeamName');
const doCreateTeam      = document.getElementById('doCreateTeam');
const cancelCreateTeam  = document.getElementById('cancelCreateTeam');
const joinTeamBox       = document.getElementById('joinTeamBox');
const joinCodeInput     = document.getElementById('joinCodeInput');
const doJoinTeam        = document.getElementById('doJoinTeam');
const cancelJoinTeam    = document.getElementById('cancelJoinTeam');

const roundsNotSigned   = document.getElementById('roundsNotSigned');
const roundsSection     = document.getElementById('roundsSection');
const roundsLockedNote  = document.getElementById('roundsLockedNote');
const r1Form            = document.getElementById('r1Form');
const r1Problem         = document.getElementById('r1Problem');
const r1Solution        = document.getElementById('r1Solution');
const r1Api             = document.getElementById('r1Api');
const r2Form            = document.getElementById('r2Form');
const r2Repo            = document.getElementById('r2Repo');
const r2Demo            = document.getElementById('r2Demo');
const r2Notes           = document.getElementById('r2Notes');
const r3Form            = document.getElementById('r3Form');
const r3Slides          = document.getElementById('r3Slides');
const r3Notes           = document.getElementById('r3Notes');

const leaderboardBody   = document.getElementById('leaderboardBody');

const judgeNotAllowed   = document.getElementById('judgeNotAllowed');
const judgeSection      = document.getElementById('judgeSection');
const judgeRound        = document.getElementById('judgeRound');
const judgeHead         = document.getElementById('judgeHead');
const judgeBody         = document.getElementById('judgeBody');
const saveScoresBtn     = document.getElementById('saveScoresBtn');

/* ---------------- Tabs ---------------- */
tabs.forEach(t=>{
  t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    Object.values(tabBlocks).forEach(b=> b.classList.add('hidden'));
    const id = t.getAttribute('data-tab');
    tabBlocks[id].classList.remove('hidden');
  });
});

/* ---------------- Countdown ---------------- */
function renderCountdown(){
  const now = new Date();
  let diff = START_AT - now;
  if (diff <= 0) {
    countdownEl.innerHTML = `<span>Started</span>`;
    return;
  }
  const d = Math.floor(diff / (1000*60*60*24));
  diff -= d*24*60*60*1000;
  const h = Math.floor(diff / (1000*60*60));
  diff -= h*60*60*1000;
  const m = Math.floor(diff / (1000*60));
  diff -= m*60*1000;
  const s = Math.floor(diff / 1000);
  countdownEl.innerHTML = `
    <span>${d}d</span><span>${h}h</span><span>${m}m</span><span>${s}s</span>
  `;
}
renderCountdown();
setInterval(renderCountdown, 1000);

/* ---------------- Toast ---------------- */
function toast(msg, ms=2500){
  toastEl.textContent = msg;
  toastEl.style.display = 'block';
  setTimeout(()=> toastEl.style.display = 'none', ms);
}

/* ---------------- Auth modal ---------------- */
openSignin?.addEventListener('click', ()=>{
  signinOverlay.classList.remove('hidden');
  showSignIn();
});
signinClose?.addEventListener('click', ()=> signinOverlay.classList.add('hidden'));
signinOverlay?.addEventListener('click', (e)=>{
  if(e.target === signinOverlay) signinOverlay.classList.add('hidden');
});

tabSignIn?.addEventListener('click', showSignIn);
tabSignUp?.addEventListener('click', showSignUp);

function showSignIn(){
  tabSignIn.classList.add('active');
  tabSignUp.classList.remove('active');
  signinForm.classList.remove('hidden');
  signupForm.classList.add('hidden');
  signinError.style.display = 'none';
}
function showSignUp(){
  tabSignUp.classList.add('active');
  tabSignIn.classList.remove('active');
  signupForm.classList.remove('hidden');
  signinForm.classList.add('hidden');
  signinError.style.display = 'none';
}

/* ---------------- Auth handlers ---------------- */
signinForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = signinEmail.value.trim();
  const pass  = signinPassword.value;
  if(!email.endsWith('@klu.ac.in')){
    return showSigninError("Only @klu.ac.in mail is allowed");
  }
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    signinOverlay.classList.add('hidden');
  }catch(err){
    showSigninError(err.message);
  }
});
signupForm?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name  = signupName.value.trim();
  const email = signupEmail.value.trim();
  const p1 = signupPassword.value;
  const p2 = signupPassword2.value;
  if(!email.endsWith('@klu.ac.in')){
    return showSigninError("Only @klu.ac.in mail is allowed");
  }
  if(p1.length < 6) return showSigninError('Password must be ≥ 6 chars');
  if(p1 !== p2) return showSigninError('Passwords do not match');
  try{
    const cred = await createUserWithEmailAndPassword(auth, email, p1);
    if(name) await updateProfile(cred.user, { displayName: name });
    signinOverlay.classList.add('hidden');
  }catch(err){
    showSigninError(err.message);
  }
});
forgotBtn?.addEventListener('click', async ()=>{
  const email = prompt("Enter your @klu.ac.in email:");
  if(!email) return;
  if(!email.endsWith('@klu.ac.in')){
    alert("Only @klu.ac.in mail is allowed"); return;
  }
  try{
    await sendPasswordResetEmail(auth, email);
    alert("Password reset email sent");
  }catch(err){
    alert(err.message);
  }
});
function showSigninError(msg){
  signinError.textContent = msg;
  signinError.style.display = 'block';
}

googleBtn?.addEventListener('click', onGoogleAuth);
googleBtn2?.addEventListener('click', onGoogleAuth);
async function onGoogleAuth(){
  const provider = new GoogleAuthProvider();
  try{
    const res = await signInWithPopup(auth, provider);
    if(!res.user.email.endsWith('@klu.ac.in')){
      await signOut(auth);
      showSigninError("Only @klu.ac.in mail is allowed");
      return;
    }
    signinOverlay.classList.add('hidden');
  }catch(err){
    showSigninError(err.message);
  }
}

/* ---------------- Avatar menu ---------------- */
avatarBtn?.addEventListener('click', ()=>{
  profileMenu.classList.toggle('hidden');
});
document.addEventListener('click', (e)=>{
  if(!profileBox.contains(e.target)){
    profileMenu.classList.add('hidden');
  }
});
logoutBtn?.addEventListener('click', async ()=>{
  await signOut(auth);
});
logoutTopBtn?.addEventListener('click', async ()=>{
  await signOut(auth);
});
viewProfileBtn?.addEventListener('click', ()=>{
  alert(`Name: ${user?.displayName || '(not set)'}\nEmail: ${user?.email}`);
  profileMenu.classList.add('hidden');
});

/* ---------------- Auth state ---------------- */
onAuthStateChanged(auth, async (u)=>{
  user = u;
  if(user && user.email && !user.email.endsWith('@klu.ac.in')){
    await signOut(auth);
    return;
  }

  if(user){
    openSignin?.classList.add('hidden');
    profileBox.classList.remove('hidden');
    logoutTopBtn.classList.remove('hidden');   // show top logout
    profileEmail.textContent = user.email;
    avatarBtn.textContent = (user.displayName?.[0] || user.email[0]).toUpperCase();
  }else{
    openSignin?.classList.remove('hidden');
    profileBox.classList.add('hidden');
    logoutTopBtn.classList.add('hidden');      // hide top logout
  }

  await loadEventConfig();
  await loadMyTeam();
  await renderTeamUI();
  await renderRoundsUI();
  await buildLeaderboard();
  setupJudgeUI();
});

/* ---------------- Event config ---------------- */
async function loadEventConfig(){
  try{
    const ref = doc(db, "events", EVENT_ID, "meta", "config");
    const snap = await getDoc(ref);
    if(snap.exists()){
      eventConfig = Object.assign(eventConfig, snap.data());
    }
  }catch(err){
    console.error("config load", err);
  }
}

/* ---------------- Team logic ---------------- */
async function loadMyTeam(){
  myTeamDoc = null;
  if(!user) return;
  const teamsRef = collection(db, "events", EVENT_ID, "teams");
  const qy = query(teamsRef, where("members", "array-contains", user.email));
  const snap = await getDocs(qy);
  if(!snap.empty){
    const d = snap.docs[0];
    myTeamDoc = { id: d.id, ...d.data() };
  }
}
async function renderTeamUI(){
  if(!user){
    teamNotSigned.classList.remove('hidden');
    teamSection.classList.add('hidden');
    return;
  }
  teamNotSigned.classList.add('hidden');
  teamSection.classList.remove('hidden');

  createTeamBox.classList.add('hidden');
  joinTeamBox.classList.add('hidden');

  if(myTeamDoc){
    teamActions.classList.add('hidden');
    teamInfo.classList.remove('hidden');
    teamInfo.innerHTML = renderTeamInfoHtml(myTeamDoc);
    attachTeamActionButtons();
  }else{
    teamInfo.classList.add('hidden');
    teamActions.classList.remove('hidden');
  }
}
function renderTeamInfoHtml(t){
  const locked = t.locked ? `<span class="pill locked">locked</span>` : '';
  const joinCode = t.locked ? '' : `<div class="muted">Join Code: <span class="inline-code">${t.joinCode}</span></div>`;
  const meIsOwner = (t.createdBy === user?.email);
  const canUnlock = meIsOwner && t.locked;

  return `
    <div style="margin-bottom:10px;">
      <h3>${t.name} ${locked}</h3>
      <div class="muted">Team ID: ${t.id}</div>
      ${joinCode}
    </div>

    <div><strong>Members (${t.members?.length || 0})</strong></div>
    <ul style="margin-top:6px;">
      ${(t.members||[]).map(m=> `<li>${m}${m===t.createdBy ? ' <span class="pill">owner</span>':''}</li>`).join('')}
    </ul>

    <div style="margin-top:10px;">
      ${(!t.locked && meIsOwner) ? `<button class="btn btn-primary" id="lockTeamBtn">Lock Team</button>` : ''}
      ${(canUnlock) ? `<button class="btn btn-outline" id="unlockTeamBtn">Unlock</button>` : ''}
      ${(!t.locked && meIsOwner) ? `<button class="btn btn-danger" id="leaveTeamBtn" disabled>Owner can't leave</button>` : `<button class="btn btn-outline" id="leaveTeamBtn">Leave Team</button>`}
    </div>
  `;
}
function attachTeamActionButtons(){
  const lockTeamBtn = document.getElementById('lockTeamBtn');
  const unlockTeamBtn = document.getElementById('unlockTeamBtn');
  const leaveTeamBtn = document.getElementById('leaveTeamBtn');
  lockTeamBtn?.addEventListener('click', lockTeam);
  unlockTeamBtn?.addEventListener('click', unlockTeam);
  leaveTeamBtn?.addEventListener('click', leaveTeam);
}
async function lockTeam(){
  if(!myTeamDoc) return;
  if(!confirm("Lock team? You cannot add more members.")) return;
  try{
    const ref = doc(db, "events", EVENT_ID, "teams", myTeamDoc.id);
    await updateDoc(ref, { locked: true, lockedAt: serverTimestamp() });
    toast("Team locked");
    await loadMyTeam();
    await renderTeamUI();
    await renderRoundsUI();
  }catch(err){ console.error(err); toast("Failed to lock"); }
}
async function unlockTeam(){
  if(!myTeamDoc) return;
  if(myTeamDoc.createdBy !== user.email){
    toast("Only owner can unlock"); return;
  }
  if(!confirm("Unlock team?")) return;
  try{
    const ref = doc(db, "events", EVENT_ID, "teams", myTeamDoc.id);
    await updateDoc(ref, { locked: false });
    toast("Unlocked");
    await loadMyTeam();
    await renderTeamUI();
  }catch(err){ console.error(err); toast("Failed to unlock"); }
}
async function leaveTeam(){
  if(!myTeamDoc) return;
  if(myTeamDoc.createdBy === user.email){
    toast("Owner cannot leave. Contact organizers.");
    return;
  }
  if(myTeamDoc.locked){
    toast("Locked team cannot be left. Contact organizers.");
    return;
  }
  if(!confirm("Leave this team?")) return;
  try{
    const ref = doc(db, "events", EVENT_ID, "teams", myTeamDoc.id);
    const newMembers = (myTeamDoc.members||[]).filter(m => m !== user.email);
    await updateDoc(ref, { members: newMembers });
    toast("Left team");
    await loadMyTeam();
    await renderTeamUI();
    await renderRoundsUI();
  }catch(err){
    console.error(err);
    toast("Failed to leave");
  }
}

/* Create / Join team flows */
createTeamBtn?.addEventListener('click', ()=>{
  createTeamBox.classList.remove('hidden');
  joinTeamBox.classList.add('hidden');
});
cancelCreateTeam?.addEventListener('click', ()=> createTeamBox.classList.add('hidden'));
joinTeamBtn?.addEventListener('click', ()=>{
  joinTeamBox.classList.remove('hidden');
  createTeamBox.classList.add('hidden');
});
cancelJoinTeam?.addEventListener('click', ()=> joinTeamBox.classList.add('hidden'));

doCreateTeam?.addEventListener('click', async ()=>{
  const name = createTeamName.value.trim();
  if(!name) return toast("Enter team name");
  try{
    await loadMyTeam();
    if(myTeamDoc) return toast("You already are in a team");

    const joinCode = genCode(6);
    await addDoc(collection(db, "events", EVENT_ID, "teams"), {
      name,
      createdAt: serverTimestamp(),
      createdBy: user.email,
      members: [user.email],
      locked: false,
      joinCode,
      r1: null, r2: null, r3: null
    });
    toast("Team created");
    await loadMyTeam();
    await renderTeamUI();
    await renderRoundsUI();
  }catch(err){
    console.error(err); toast("Failed to create team");
  }
});

doJoinTeam?.addEventListener('click', async ()=>{
  const code = joinCodeInput.value.trim().toUpperCase();
  if(!code) return toast("Enter join code");
  try{
    await loadMyTeam();
    if(myTeamDoc) return toast("You're already in a team");

    const colRef = collection(db, "events", EVENT_ID, "teams");
    const qy = query(colRef, where("joinCode", "==", code));
    const snap = await getDocs(qy);
    if(snap.empty){ toast("Invalid code"); return; }
    const docSnap = snap.docs[0];
    const t = { id: docSnap.id, ...docSnap.data() };
    if(t.locked){ toast("Team is locked"); return; }
    const members = t.members || [];
    if(members.includes(user.email)){ toast("Already in that team"); return; }
    const maxSize = eventConfig.maxTeamSize || 4;
    if(members.length >= maxSize){ toast("Team is full"); return; }

    const ref = doc(db, "events", EVENT_ID, "teams", t.id);
    await updateDoc(ref, { members: [...members, user.email] });

    toast("Joined team");
    await loadMyTeam();
    await renderTeamUI();
    await renderRoundsUI();
  }catch(err){
    console.error(err); toast("Join failed");
  }
});

function genCode(n){
  return Math.random().toString(36).substring(2, 2+n).toUpperCase();
}

/* ---------------- Rounds & Submissions ---------------- */
async function renderRoundsUI(){
  if(!user){
    roundsNotSigned.classList.remove('hidden');
    roundsSection.classList.add('hidden');
    return;
  }
  if(!myTeamDoc){
    roundsNotSigned.classList.remove('hidden');
    roundsSection.classList.add('hidden');
    roundsNotSigned.textContent = "Join a team to submit.";
    return;
  }
  roundsNotSigned.classList.add('hidden');
  roundsSection.classList.remove('hidden');

  roundsLockedNote.classList.toggle('hidden', !myTeamDoc.locked);

  await loadMyTeam();
  r1Problem.value  = myTeamDoc?.r1?.problem  || "";
  r1Solution.value = myTeamDoc?.r1?.solution || "";
  r1Api.value      = myTeamDoc?.r1?.api      || "";

  r2Repo.value   = myTeamDoc?.r2?.repo  || "";
  r2Demo.value   = myTeamDoc?.r2?.demo  || "";
  r2Notes.value  = myTeamDoc?.r2?.notes || "";

  r3Slides.value = myTeamDoc?.r3?.slides || "";
  r3Notes.value  = myTeamDoc?.r3?.notes  || "";
}

r1Form?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!myTeamDoc) return;
  try{
    const ref = doc(db, "events", EVENT_ID, "teams", myTeamDoc.id);
    await updateDoc(ref, {
      r1: {
        problem: r1Problem.value.trim(),
        solution: r1Solution.value.trim(),
        api: r1Api.value.trim(),
        updatedAt: serverTimestamp()
      }
    });
    toast("Round 1 saved");
  }catch(err){ console.error(err); toast("Save failed"); }
});
r2Form?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!myTeamDoc) return;
  try{
    const ref = doc(db, "events", EVENT_ID, "teams", myTeamDoc.id);
    await updateDoc(ref, {
        r2: {
          repo: r2Repo.value.trim(),
          demo: r2Demo.value.trim(),
          notes: r2Notes.value.trim(),
          updatedAt: serverTimestamp()
        }
    });
    toast("Round 2 saved");
  }catch(err){ console.error(err); toast("Save failed"); }
});
r3Form?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!myTeamDoc) return;
  try{
    const ref = doc(db, "events", EVENT_ID, "teams", myTeamDoc.id);
    await updateDoc(ref, {
      r3: {
        slides: r3Slides.value.trim(),
        notes: r3Notes.value.trim(),
        updatedAt: serverTimestamp()
      }
    });
    toast("Round 3 saved");
  }catch(err){ console.error(err); toast("Save failed"); }
});

/* ---------------- Leaderboard ---------------- */
async function buildLeaderboard(){
  leaderboardBody.innerHTML = '';
  const teamsRef = collection(db, "events", EVENT_ID, "teams");
  const snap = await getDocs(teamsRef);
  const teams = [];
  snap.forEach(d => teams.push({ id: d.id, ...d.data() }));

  const scoresRef = collection(db, "events", EVENT_ID, "scores");
  const scoresSnap = await getDocs(scoresRef);
  const scores = {};
  scoresSnap.forEach(s=>{
    const d = s.data();
    if(!scores[d.teamId]) scores[d.teamId] = { r1:[], r2:[], r3:[] };
    if(d.round === 1) scores[d.teamId].r1.push(d);
    if(d.round === 2) scores[d.teamId].r2.push(d);
    if(d.round === 3) scores[d.teamId].r3.push(d);
  });

  const rows = teams.map(t=>{
    const sc = scores[t.id] || { r1:[], r2:[], r3:[] };
    const r1 = avgScore(sc.r1);
    const r2 = avgScore(sc.r2);
    const r3 = avgScore(sc.r3);
    const total = r1 + r2 + r3;
    return { team: t.name, r1, r2, r3, total };
  });

  rows.sort((a,b)=> b.total - a.total);

  rows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${r.team}</td>
      <td>${r.r1}</td>
      <td>${r.r2}</td>
      <td>${r.r3}</td>
      <td><strong>${r.total}</strong></td>
    `;
    leaderboardBody.appendChild(tr);
  });
}
function avgScore(arr){
  if(!arr.length) return 0;
  const sums = arr.map(x => Number(x.total||0));
  const total = sums.reduce((a,b)=> a+b, 0);
  return Math.round((total / arr.length) * 100) / 100;
}

/* ---------------- Judge Console ---------------- */
function setupJudgeUI(){
  if(!user){ showJudge(false); return; }
  isJudge = eventConfig.judges?.includes(user.email);
  showJudge(isJudge);
  if(!isJudge) return;
  judgeRound.addEventListener('change', loadJudgeTable);
  loadJudgeTable();
  saveScoresBtn.addEventListener('click', saveScores);
}
function showJudge(flag){
  if(flag){
    judgeNotAllowed.classList.add('hidden');
    judgeSection.classList.remove('hidden');
  }else{
    judgeNotAllowed.classList.remove('hidden');
    judgeSection.classList.add('hidden');
  }
}
async function loadJudgeTable(){
  const r = Number(judgeRound.value);
  if(r === 1){
    judgeHead.innerHTML = `
      <tr>
        <th>#</th>
        <th>Team</th>
        <th>Problem clarity (5)</th>
        <th>Feasibility & creativity (5)</th>
        <th>API relevance (5)</th>
        <th>Total</th>
      </tr>
    `;
  }else if(r === 2){
    judgeHead.innerHTML = `
      <tr>
        <th>#</th>
        <th>Team</th>
        <th>API integration (20)</th>
        <th>Functionality (20)</th>
        <th>UI/UX (10)</th>
        <th>Code quality (5)</th>
        <th>Total</th>
      </tr>
    `;
  }else{
    judgeHead.innerHTML = `
      <tr>
        <th>#</th>
        <th>Team</th>
        <th>Explanation & demo (10)</th>
        <th>Creativity & impact (10)</th>
        <th>Time mgmt (5)</th>
        <th>Team collab / solo (5)</th>
        <th>Total</th>
      </tr>
    `;
  }

  judgeBody.innerHTML = '';

  const teamsRef = collection(db, "events", EVENT_ID, "teams");
  const snap = await getDocs(teamsRef);
  const teams = [];
  snap.forEach(d => teams.push({ id: d.id, ...d.data() }));
  teams.sort((a,b)=> a.name.localeCompare(b.name));

  const myScores = {};
  const scoresRef = collection(db, "events", EVENT_ID, "scores");
  const qy = query(scoresRef, where("round","==", r), where("judge","==", user.email));
  const scSnap = await getDocs(qy);
  scSnap.forEach(s => myScores[s.data().teamId] = s.data());

  teams.forEach((t, idx)=>{
    const sc = myScores[t.id] || {};
    const tr = document.createElement('tr');
    if(r === 1){
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${t.name}</td>
        <td><input class="score-input" data-k="pc" data-team="${t.id}" value="${sc.pc||0}" max="5" type="number" min="0"></td>
        <td><input class="score-input" data-k="fc" data-team="${t.id}" value="${sc.fc||0}" max="5" type="number" min="0"></td>
        <td><input class="score-input" data-k="ar" data-team="${t.id}" value="${sc.ar||0}" max="5" type="number" min="0"></td>
        <td class="total-cell" data-team="${t.id}">${sc.total||0}</td>
      `;
    }else if(r === 2){
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${t.name}</td>
        <td><input class="score-input" data-k="ai" data-team="${t.id}" value="${sc.ai||0}" max="20" type="number" min="0"></td>
        <td><input class="score-input" data-k="fn" data-team="${t.id}" value="${sc.fn||0}" max="20" type="number" min="0"></td>
        <td><input class="score-input" data-k="ux" data-team="${t.id}" value="${sc.ux||0}" max="10" type="number" min="0"></td>
        <td><input class="score-input" data-k="cq" data-team="${t.id}" value="${sc.cq||0}" max="5" type="number" min="0"></td>
        <td class="total-cell" data-team="${t.id}">${sc.total||0}</td>
      `;
    }else{
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${t.name}</td>
        <td><input class="score-input" data-k="ed" data-team="${t.id}" value="${sc.ed||0}" max="10" type="number" min="0"></td>
        <td><input class="score-input" data-k="ci" data-team="${t.id}" value="${sc.ci||0}" max="10" type="number" min="0"></td>
        <td><input class="score-input" data-k="tm" data-team="${t.id}" value="${sc.tm||0}" max="5" type="number" min="0"></td>
        <td><input class="score-input" data-k="tc" data-team="${t.id}" value="${sc.tc||0}" max="5" type="number" min="0"></td>
        <td class="total-cell" data-team="${t.id}">${sc.total||0}</td>
      `;
    }
    judgeBody.appendChild(tr);
  });

  judgeBody.querySelectorAll('.score-input').forEach(inp=>{
    inp.addEventListener('input', recomputeRowTotal);
  });
}
function recomputeRowTotal(e){
  const teamId = e.target.getAttribute('data-team');
  const inputs = [...judgeBody.querySelectorAll(`.score-input[data-team="${teamId}"]`)];
  let sum = 0;
  inputs.forEach(i => sum += Number(i.value||0));
  const cell = judgeBody.querySelector(`.total-cell[data-team="${teamId}"]`);
  cell.textContent = sum;
}
async function saveScores(){
  const r = Number(judgeRound.value);
  const rows = {};
  judgeBody.querySelectorAll('.score-input').forEach(inp=>{
    const teamId = inp.getAttribute('data-team');
    const k = inp.getAttribute('data-k');
    const v = Number(inp.value);
    rows[teamId] = rows[teamId] || {};
    rows[teamId][k] = v;
  });

  for(const teamId of Object.keys(rows)){
    const data = rows[teamId];
    const total = Object.values(data).reduce((a,b)=> a+b, 0);
    await setDoc(doc(db, "events", EVENT_ID, "scores", `${teamId}_${user.email}_r${r}`), {
      teamId,
      judge: user.email,
      round: r,
      ...data,
      total,
      updatedAt: serverTimestamp()
    }, { merge:true });
  }
  toast("Scores saved");
  await buildLeaderboard();
}
</script>
</body>
</html>
